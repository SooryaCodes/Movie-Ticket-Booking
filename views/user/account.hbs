<link rel="stylesheet" href="/stylesheets/user/account.css">
<div class="alerts">

</div>
<div class="big-wrapper">

    <div class="user-dash">
        <div class="profile-section">
            <div class="img-section" title="Edit Image">
                <img src="data:image/jpeg;base64,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"
                    alt="">
            </div>
            <div class="profile-details">
                <i class="fa fa-user left-icon" aria-hidden="true"></i>
                <input autocomplete="off" type="text" name="name" class="input" placeholder="Name" value="Soorya"
                    disabled>
                <div class="control">
                    <i class="fas fa-check check1 check"></i>
                    <i class="fas fa-pen pen1 pen active"></i>
                </div>
            </div>
            <div class="profile-details">
                <i class="fa fa-mobile-alt left-icon" aria-hidden="true"></i>
                <input autocomplete="off" type="number" name="mobile" class="input" placeholder="Mobile"
                    value="8943713703" disabled>
                <div class="control">
                    <i class="fas fa-check check2 check"></i>
                    <i class="fas fa-pen pen2 pen active"></i>
                </div>
            </div>
            <div class="profile-details">
                <i class="fa fa-envelope left-icon" aria-hidden="true"></i>
                <input autocomplete="off" type="email" name="email" class="input" placeholder="Email"
                    value="sooryakriz111@gmail.com" disabled>
                <div class="control">
                    <i class="fas fa-check check3 check"></i>
                    <i class="fas fa-pen pen3 pen active"></i>
                </div>
            </div>
        </div>
        <div class="referal-section">
            <h4>My Referal</h4>
            <hr>
            <p>Share The Referal Link And Get Credit Up 100 Rs On His / Her First Booking.</p>
            <div class="referal-details">
                <i class="fas fa-link    "></i>
                <input type="text" name="referal" value="http://localhost:3000/login?ref={{userDetails.My_Referal}}"
                    readonly class="link" id="">
                <i class="fas fa-copy" title="Copy" class="copy" onclick="copy()"></i>
            </div>
            <div class="copied">
                <p><i class="fas fa-check    "></i> Copied Successfully</p>
            </div>
        </div>
    </div>
    <div class="user-dash">
        <div class="wallet-section">
            <h4>My Wallet</h4>
            <hr>
            <p><span id="wallet"></span>Rs</p>
            <p>Balance.</p>
            <img src="/images/user/clipart2061111.png" alt="">
        </div>
        <div class="analytics-section">
            <div class="analytic">
                <i class="fas fa-clipboard-list    "></i>
                <div class="a-content">
                    <p>Booking</p>
                    <span id="Booking">20</span>
                </div>
            </div>

            <div class="analytic">
                <i class="fas fa-money-bill-wave  " style="color: rgb(255, 128, 128);"></i>
                <div class="a-content">
                    <p>Payments</p>
                    <span style="color: rgb(255, 128, 128);" id="Payments">20</span>
                </div>
            </div>

            <div class="analytic">
                <i class="fas fa-info-circle    " style="color: #aefcff;"></i>
                <div class="a-content">
                    <p>Pendings</p>
                    <span style="color: #aefcff;" id="Pendings">20</span>
                </div>
            </div>

            <div class="analytic">
                <i class="fas fa-coins    " style="color: #fffd80;"></i>
                <div class="a-content">
                    <p>Rewards</p>
                    <span style="color: #fffd80;" id="Rewards">20</span>
                </div>
            </div>
        </div>
    </div>
</div>


<!--table -->
<div class="owner-table">

    <table id="table">

        <tr>

            <th>
                Movie
            </th>

            <th>
                Theater
            </th>
            <th>
                Screen
            </th>
            <th>
                Show

            </th>
            <th>
                Seats
            </th>
            <th>
                Payment
            </th>
        </tr>



    </table>
</div>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>


    const getUserDetails = () => {
        $.ajax({
            url: '/getUserDetails',
            method: 'post',
            success: (response) => {
                document.querySelector('input[name="name"]').value = `${response.Name}`
                document.querySelector('input[name="email"]').value = `${response.Email}`
                document.querySelector('input[name="mobile"]').value = `${response.Mobile}`
                var Wallet = response.Wallet
                if (Wallet === undefined) {
                    document.querySelector('#wallet').innerHTML = `0`

                } else {

                    document.querySelector('#wallet').innerHTML = `${Wallet}`

                }

                var Rewards = response.Rewards
                document.getElementById('Rewards').innerHTML = Rewards.length

            }
        })
    }

    window.addEventListener('load', () => {
        getUserDetails()
    })
    const updateName = (Name) => {
        var data = {
            Name: Name
        }
        $.ajax({
            url: '/update-name',
            method: 'post',
            data: data,
            success: () => {
                getUserDetails()
            }
        })
    }
    const updateMobile = (Mobile) => {
        var data = {
            Mobile: Mobile
        }
        $.ajax({
            url: '/update-mobile',
            method: 'post',
            data: data,
            success: () => {
                getUserDetails()
            }
        })
    }
    const updateEmail = (Email) => {
        var data = {
            Email: Email
        }
        $.ajax({
            url: '/update-email',
            method: 'post',
            data: data,
            success: (response) => {
                if (response.Logout === true) {
                    var name = document.querySelector('input[name="name"]').value
                    document.querySelector('.alerts').innerHTML = `    <div class="alert  alert-dismissible fade show" role="alert" style="background:#464d75;position: fixed;top: 70px; color:white;box-shadow:0px 0px 20px #222538">
    <strong>Hi ${name}.</strong> You Have Changed Your Email So Login Again.
  </div>`

                    getUserDetails()

                    setTimeout(function () {
                        location.href = '/logout'
                    }, 7000)

                } else {

                    getUserDetails()
                }
            }
        })
    }

    var edit1 = document.querySelector('.pen1')
    var check1 = document.querySelector('.check1')
    var edit2 = document.querySelector('.pen2')
    var check2 = document.querySelector('.check2')
    var edit3 = document.querySelector('.pen3')
    var check3 = document.querySelector('.check3')


    //name function
    edit1.addEventListener('click', () => {
        var name = document.querySelector('input[name="name"]')
        edit1.classList.remove('active')
        name.disabled = false
        check1.classList.toggle('active')
    })



    check1.addEventListener('click', () => {
        var name = document.querySelector('input[name="name"]')
        edit1.classList.toggle('active')
        updateName(name.value)
        name.disabled = true
        check1.classList.remove('active')
    })

    //mobile function
    edit2.addEventListener('click', () => {
        var mobile = document.querySelector('input[name="mobile"]')
        edit2.classList.remove('active')
        mobile.disabled = false
        check2.classList.toggle('active')
    })



    check2.addEventListener('click', () => {
        var mobile = document.querySelector('input[name="mobile"]')
        edit2.classList.toggle('active')
        updateMobile(mobile.value)
        mobile.disabled = true
        check2.classList.remove('active')
    })
    //email function
    edit3.addEventListener('click', () => {
        var mail = document.querySelector('input[name="email"]')
        edit3.classList.remove('active')
        mail.disabled = false
        check3.classList.toggle('active')
    })



    check3.addEventListener('click', () => {
        var mail = document.querySelector('input[name="email"]')
        edit3.classList.toggle('active')
        updateEmail(mail.value)
        mail.disabled = true
        check3.classList.remove('active')
    })


    const copy = () => {
        var link = document.querySelector('input[name="referal"]')
        console.log(link);
        var copied = document.querySelector('.copied')
        /* Select the text field */
        link.select();

        /* Copy the text inside the text field */
        document.execCommand("copy");
        copied.classList.add('active')

    }





    window.addEventListener('load', () => {
        $.ajax({
            url: '/getBookings',
            method: 'post',
            success: (response) => {
                var Pendings = []
                document.getElementById('Booking').innerHTML = response.length
                document.getElementById('Payments').innerHTML = response.length
                document.getElementById('Pendings').innerHTML = Pendings.length
                if (response.length === 0) {
                    var table = document.getElementById('table').innerHTML += ` <tr> <td style="width:100%;font-size:20px;font-weight:600;">Sorry, You Have No Bookings.</td></tr>`

                } else {

                    for (var i = 0; i < response.length; i++) {

                        if (response[i].Payment_Status === 'Paid') {
                            var table = document.getElementById('table').innerHTML += ` <tr>
            <td>${response[i].ShowsDetails.MovieName}</td>
            <td>${response[i].Theater.Theater}</td>
            <td>${response[i].Show.screenName}</td>
            <td>${response[i].ShowsDetails.Date} | ${response[i].ShowsDetails.Time} </td>
            <td><button class="show-btn" onclick="showSeat('${response[i]._id}','${response[i].Seat}')">Show</button></td>
            <td>
                <div class="status-a"></div>
                Paid
            </td>
            <div class="seat-pop-wrapper " id="${response[i]._id}">
                <div class="seat-pop " id="${response[i]._id + response[i]._id}">
                    <p></p>
                </div>
            </div>

        </tr>`

                        } else {
                            Pendings[i] = response[i]
                            var table = document.getElementById('table').innerHTML += ` <tr>
            <td>${response[i].ShowsDetails.MovieName}</td>
            <td>${response[i].Theater.Theater}</td>
            <td>${response[i].Show.screenName}</td>
            <td>${response[i].ShowsDetails.Date} | ${response[i].ShowsDetails.Time} </td>
            <td><button class="show-btn" onclick="showSeat('${response[i]._id}','${response[i].Seat}')">Show</button></td>
            <td>
                <button id="pay" onclick="payment('${response[i].Payment}','${response[i]._id}')">Pay Now</button>
            </td>
            <div class="seat-pop-wrapper " id="${response[i]._id}">
                <div class="seat-pop " id="${response[i]._id + response[i]._id}">
                    <p></p>
                </div>
            </div>

        </tr>`

                        }
                    }
                }

            }
        })
    })


    const showSeat = (id, array) => {
        var wrapper = document.getElementById(`${id}`)
        var pop = document.getElementById(`${id + id}`).innerHTML = `<p>${array}</p>`
        wrapper.classList.toggle('active')
        wrapper.addEventListener('click', () => {
            wrapper.classList.remove('active')
        })
    }
</script>


<script>
    const payment = (method, id) => {
        $.ajax({
            url: '/another-payment/' + method + '/' + id,
            method: 'post',
            success: (response) => {
                console.log(response)
                if (response.Razorpay === true) {
                    console.log(response, 'response')
                    razorpayPayment(response.order)
                } else if (response.Paypal === true) {
                    location.href = response.payment.links[1].href
                }
            }
        })
    }


    const razorpayPayment = (data) => {
        console.log(data, "data in razorpay");
        var options = {
            key: "rzp_test_kX6azReFALaRXo", // Enter the Key ID generated from the Dashboard
            amount: data.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
            currency: "INR",
            name: "Movie Cafe",
            description: "Ticket Booking",
            image: "",
            order_id: data.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
            handler: function (response) {

                verifyPayment(response, data);
            },
            prefill: {
                name: '',
                email: '',
                contact: '',
            },
            notes: {
                address: "Razorpay Corporate Office",
            },
            theme: {
                color: "#4B6591",
            },
        };
        var rzp1 = new Razorpay(options);
        rzp1.on("payment.failed", function (response) {
            alert(response.error.code);
            alert(response.error.description);
            alert(response.error.source);
            alert(response.error.step);
            alert(response.error.reason);
            alert(response.error.metadata.order_id);
            alert(response.error.metadata.payment_id);
        });
        setTimeout(function () {
            razorpayUp();
        }, 1000);

        function razorpayUp() {
            rzp1.open();
        }
    };




    function verifyPayment(payment, order) {
        console.log(payment, 'payment');
        console.log(order, 'order');
        $.ajax({
            url: "/verify-payment",
            method: "post",
            data: {
                payment,
                order,
            },
            success: (response) => {
                // bookSuccess();

                if (response.status === true) {


                    location.href = "/booking-success?id=" + order.receipt;
                } else {

                    location.href = "/booking-failure?id=" + order.receipt;
                }
            },
        });
    }


</script>